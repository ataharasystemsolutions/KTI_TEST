
@{
    ViewBag.Title = "Onboard Vessel";
    Layout = "~/Views/Shared/_AdminLteLayout.cshtml";
}

<section class="content">
    <div class="row">

        <div class="col-md-12">
            <div class="box box-warning">
                <div class="box-header with-border">
                    <button type="button" id="addnew" data-toggle="modal" data-target="#modal-add" class="btn btn-primary"> <i class="fa fa-plus-circle fa-1x"></i> New</button>
                    
    
    @*<h3 class="box-title">Select2</h3>

                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-remove"></i></button>
                        </div>*@
                </div>
                <div class="box-body">
                    <table id="example1" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                
                                <th>No.</th>
                                <th>Total Item Count</th>
                                <th>Date</th>
                                <th>Mnemonic</th>
                                <th>Vessel Name</th>
                                <th>Voyage No.</th>
                                <th>Status</th>
                                <th>Action </th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int cnt = 1;
                                foreach (var item in ViewBag.onloadVesselList)
                                {
                                    var classss = item.status == "For Departure" ? "label label-success": item.status=="Departure"? "label label-warning" : item.status == "Arrival" ? "label label-primary" : "label label - danger";


                                                        <tr id="row_@item.onboardID">
                                                            
                                                            <td>@cnt.</td>
                                                            <td>
                                                                @item.itemCount
                                                                <a title="Load List"><i class='fa fa-list-ol' tooltip="Load List"></i></a>
                                                            </td>          
                                                            <td>@item.dateCreated</td>
                                                            <td>@item.vesselMnemonic</td>
                                                            <td>@item.vessleName</td>
                                                            <td>@item.voyageNo</td>
                                                            <td><a><span class="@classss">@item.status</span></a></td>
                                                            <td>
                                                                <a title="Voyage Route"><i class='fa  fa-location-arrow'></i></a>
                                                            </td>
                                                        </tr>
                                    cnt++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
    <div class="modal fade in" id="modal-add" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" onclick="closePOPUP(this);" id="btnminiClose" class="close" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Load Vessel Form</h4>
                </div>

                <div class="box-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="vv">Vessel Voyage</label>
                                <select id="vesselvoyage" class="form-control select2" style=" width:100%">
                                    <option value="0">Select</option>
                                    @{
                                        foreach (var item in ViewBag.vesList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dNum">Vessel Name</label>
                                    <input id="vesselname" type="text" class="form-control" readonly="readonly" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dNum">Voyage Number</label>
                                    <input id="voyageNo" type="text" class="form-control" readonly="readonly" />
                                    </div>

                                </div>
                                @*<div class="form-group">
                                    <button type="submit" id="btnAdd" class="btn btn-success btn-block">Search</button>
                                </div>*@
               
                            <div class="col-md-12">
                                <table id="example2" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th> <input type="checkbox" id="selectAll"></th>
                                            <th>No.</th>
                                            <th>Vessel</th>
                                            <th>Voyage No.</th>
                                            <th>Bill of Lading No.</th>
                                            <th>Transaction No.</th>
                                            <th style=" display:none;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6">No Data Found!</td>
                                        </tr>
                                        
                                    </tbody>
                                </table>

                            </div>
                            <!-- /.row -->
                        </div>
                        </div>
                        <!-- /.box -->
                        <div class="modal-footer">
                            <button type="button" id="btnClose" onclick="closePOPUP(this);" class="btn btn-default pull-left" >Close</button>
                            <button type="submit" id="btnsubmit" onclick="submitOnboardVessel(this);" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</section>
@section Scripts{
    <script src="~/Scripts/bootstap-toggle.js"></script>
    <!-- page script -->
    <script>
        //intialization
        $(document).ready(function () {
            
        });
        $(function () {

            $('.select2').select2();
            //$('#example1').DataTable()
            $('#example1').DataTable({
                'paging': true,
                'lengthChange': true,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': false
            })

            // get all data  from finalbilling where the status is Billed and get the details of vessel and voyage.
            $("#vesselvoyage").change(function () {
                var voyageId = $(this).val();
                console.log(voyageId);
                $.ajax({
                    type: "POST",
                    url: "/OnboardVessel/getbillofladingpervoyageno",
                    data: { voyageId: voyageId },
                    success: function (data) {
                        var tbl = $("#example2 > tbody");

                        if (data.voyageDetails.length > 0 || data.getBOL.length > 0) {
                            tbl.empty();
                            var cnt = 1;

                            $("#vesselname").val(data.voyageDetails[0].vesselname);
                            $("#voyageNo").val(data.voyageDetails[0].voyageNo);
                            $.each(data.getBOL, function (index, row) {

                                var tr = "<tr> " +
                                    "<td style=' display:none;'>" + row.billID + "</td>" +
                                    "<td><input type=checkbox id="+row.billID+" /></td> " +
                                    "<td>" + cnt + ".</td>" +
                                    "<td>" + row.vesselName + "</td>" +
                                    "<td>" + row.voyageNumber + "</td>" +
                                    "<td>" + row.billofladingNo + "</td>" +
                                    "<td>" + row.transactionNo + "</td>" +
                                    "<td style=' display:none;'><a type='button' onclick='Remove(this);'><i class='fa fa-trash'></i></a></td>" +
                                    "</tr > ";
                                tbl.append(tr);
                                cnt++;
                            });
                            var $selectAll = $('#selectAll'); // main checkbox inside table thead
                            var $table = $('#example2'); // table selector
                            var $tdCheckbox = $table.find('tbody input:checkbox'); // checboxes inside table body
                            var tdCheckboxChecked = 0; // checked checboxes

                            // Select or deselect all checkboxes depending on main checkbox change
                            $selectAll.on('click', function () {
                                $tdCheckbox.prop('checked', this.checked);
                            });

                            // Toggle main checkbox state to checked when all checkboxes inside tbody tag is checked
                            $tdCheckbox.on('change', function (e) {
                                tdCheckboxChecked = $table.find('tbody input:checkbox:checked').length; // Get count of checkboxes that is checked
                                // if all checkboxes are checked, then set property of main checkbox to "true", else set to "false"
                                $selectAll.prop('checked', (tdCheckboxChecked === $tdCheckbox.length));
                            })
                        }
                        else
                        {
                            tbl.empty();
                            tbl.append("<tr> <td colspan='6'>No Data Found!</td></tr>");
                            $("#vesselname").val("");
                            $("#voyageNo").val("");
                        }

                    }
                })
            })

        });
        function Remove(button) {
            //Determine the reference of the Row using the Button.
            var row = $(button).closest("TR");
            //Get the reference of the Table.
            var table = $("#example2")[0];
            //Delete the Table row using it's Index.
            table.deleteRow(row[0].rowIndex);

            var rowCount = $('#example2 > tbody > tr').length;
            if (rowCount == 0) {
                $("#vesselname").val("");
                $("#voyageNo").val("");
                $('#vesselvoyage').val('0')
                $('#vesselvoyage').trigger('change')
                $("#example2 > tbody").append("<tr> <td colspan='6'>No Data Found!</td></tr>");
            }
        };
        function closePOPUP(button) {
          window.location.href = '/OnboardVessel/onboard';
        }
        var submitOnboardVessel = function () {
            var vesselvoyage = document.getElementById('vesselvoyage');
            var voyageselected = vesselvoyage.options[vesselvoyage.selectedIndex].text;
            var voyageselectedId = vesselvoyage.options[vesselvoyage.selectedIndex].value;

            var datParent = {
                vesselName: $("#vesselname").val(),
                voyageNo: $("#voyageNo").val(),
                voyageID: voyageselectedId

            };
            var data = new Array();
            $("#example2 > tbody tr").each(function (i) {
                var $table = $('#example2'); // table selector
                var $tdCheckbox = $table.find('tbody input:checkbox:checked').length;
                //var $tdCheckbox = $table.find('tbody input:checkbox').checked; // checboxes inside table body
               
                var row = $(this);

                var getvalCHK = row.find("TD").eq(1).find("input:checkbox:checked").length;
                console.log(getvalCHK);
                if (getvalCHK == 1) {
                    var dat = {
                        billID: row.find("TD").eq(0).html(),
                        billofLadingNo: row.find("TD").eq(5).html()
                    }
                    data.push(dat);
                }
            });

            var consolidate = {
                datParent: datParent,
                data: data,
            }

            $.ajax({
                type: "POST",
                url: "../../../OnboardVessel/SaveOnboardVessel",
                data: JSON.stringify(consolidate),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (r)
                {

                }
            });

        }
    </script>
}
<style type="text/css">
   /* .modal-lg {
        width: 1200px;
    }*/


    .select2-container .select2-selection--single {
        box-sizing: border-box;
        cursor: pointer;
        display: block;
        height: 31px;
        user-select: none;
        -webkit-user-select: none;
    }
</style>
